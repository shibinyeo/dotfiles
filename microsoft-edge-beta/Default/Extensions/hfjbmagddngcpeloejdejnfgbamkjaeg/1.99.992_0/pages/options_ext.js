"use strict";__filename="pages/options_ext.js",define(["require","exports","./async_bg","./options_base","./options_defs","./options_permissions","./options_wnd"],function(n,e,o,t,i,r,l){function u(n){return new Date(+n-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,-5).replace("T"," ")}function s(n,e){return e&&("omniBlockList"===n||c(e))?"$base64:"+btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(n,e){return String.fromCharCode(parseInt(e,16))})):e}function c(n){var e,o;if(null==b){for(o of(e=[],t.u.z("omniBlockList").split("\n")))o.trim()&&"#"!==o[0]&&e.push(o);b=e.length>0&&new RegExp(e.map(function(n){return n.replace(/[$()*+.?\[\\\]\^{|}]/g,"\\$&")}).join("|"),"")}return false!==b&&b.test(n)}function a(n){return n instanceof Array&&(n=n.join("\n").trimRight()),(n=n.replace(/\r\n?/g,"\n").replace(/\xa0/g," ")).replace(/^\$base64:(.*)/gm,function(n,e){try{return decodeURIComponent([].map.call(atob(e),function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""))}catch(n){}return n})}function f(n,e,s){return __awaiter(this,void 0,void 0,function*(){var c,f,d,m,v,b,h,_,w,S,V,O,k,A,C,L,R,x,j,T,P,B=this,E=e.environment,N=E&&E.platform||"",H=E&&E.extension&&E.extension+""||"",F=parseFloat(H||0)||0,U=F>1?H.split(".",2).join("."):"",D=F>parseFloat(r.yn.version);if(N&&(N=(""+N).slice(0,10)),confirm(t.t("confirmImport",[t.t(true!==s?"backupFile":"recommendedFile"),U?t.t("fileVCVer").replace("*",U):"",(U?t.t("fileVCVer_2").replace("*",U):"")+(D?t.t("fileVCNewer"):""),N?t.t("filePlatform",[t.t(N)||N[0].toUpperCase()+N.slice(1)]):t.t("commonPlatform"),n?t.t("atTime",[u(n)]):t.t("before")]))){for(w in c=new Date,f=y(c,false),Object.setPrototypeOf(e,null),(d=e["chromium"in e?"chromium":"chrome"])&&"object"==typeof d&&Object.assign(e,d),null==e.vimSync&&(v=(m=t.u.z("vimSync"))&&confirm(t.t("keepSyncing")),e.vimSync=v||null==m&&null,m&&console.log("Before importing: You chose to",v?"keep settings synced.":"stop syncing settings.")),b=function(n,e,o,t){var i=arguments.length>3,r=i?t:o,l=["%s %c%s",n,"color:darkred",e];r="string"!=typeof r||r.length<=72?r:r.slice(0,71).trimRight()+" \u2026",i&&l.push(o),l.push(r),h++,console.log.apply(console,l)},h=0,console.group("Import settings at "+u(+c+1)),o.R(8),n>1e4?console.info("load settings saved at %c%s%c.","color:darkblue",u(n),"color:auto"):console.info("load the settings:",s?"recommended.":"saved before."),(_=function(n){return n.split(/\s+/g).forEach(function(n){return n&&delete e[n]})})("name time environment author description chrome chromium firefox edge safari"),e)"@"===w[0]&&delete e[w];for(w in S=function(n){var o=e[n];"string"==typeof o&&o.includes("extension://",2)&&(/^(chrome|edge)-/.test(o)?o.startsWith("edge-")&&(e[n]=o.replace("edge-","chrome-")):delete e[n])},S("vomnibarPage"),S("newTabUrl"),V=t.o(),O=t.u.S,k=t.r.n,V)V[w]===O[w]||w in e||(e[w]=null);for(w in _("findModeRawQueryList innerCSS findCSS omniCSS newTabUrl_f vomnibarPage_f\n      focusNewTabContent dialogMode"),A={__proto__:null,extWhiteList:"extAllowList",phraseBlacklist:"omniBlockList"})w in e&&(e[A[w]]=e[w],delete e[w]);for(j of(null==e.keyLayout&&(L=e[p[1]],R=e[p[2]],void 0===(C=e[p[0]])&&void 0===L&&void 0===R||(x=void 0,x=null==(C=null!==C?C+"":C)?4:"2"===C||"true"===C?1:"1"===C?12:4,x|=null==(L=null!==L?L+"":L)||1===x?0:"2"===L||"true"===L?16:"1"===L?512:0,x|=null==(R=null!==R?R+"":R)?0:"2"===R?128:"1"===R?64:0,e.keyLayout=x|=256)),p))delete e[j];e.vimSync!==t.u.z("vimSync")&&(b("import","vimSync",e.vimSync),yield t.u.J("vimSync",e.vimSync),yield k.vimSync.Z()),void 0!==(T=k.keyMappings)&&(delete k.keyMappings,k.keyMappings=T),yield Promise.all(Object.values(k).map(function(n){return __awaiter(B,void 0,void 0,function*(){var o=n.T,i=e[o];if(delete e[o],o in O)return null==i?i=O[o]:("string"==typeof O[o]&&(i=a(i)),i=yield n.I(i)),n.et(yield n.q(),i)?n.K?void 0:n.Z():(b("import",o,i),yield t.u.J(o,i),o in t.u.L&&t.r.st.push(o),yield n.Z(),n.F())})})).catch(function(n){b("[ERROR] importing options failed","cause:",n)}),yield Promise.all(Object.keys(e).map(function(n){return __awaiter(B,void 0,void 0,function*(){var i=e[n];if(null==i)if(n in O){if(i=O[n],t.u.z(n)!==i)return b("reset",n,i),t.u.J(n,i)}else if(n.includes("|"))return b("remove",n,"(from local)"),o.O(28,{key:n,val:null});if("string"==typeof O[n]&&(i=a(i)),n in O){if(t.u.z(n)!==i)return b("update",n,i),t.u.J(n,i)}else if(n.includes("|"))return b("save",n,i=""+i),o.O(28,{key:n,val:i})})})).catch(function(n){b("[ERROR] saving fields failed","cause:",n)}),o.R(0,8),yield 0,i.At.onclick(false),l.advancedOptBtn.getAttribute("aria-checked")!==""+t.u.z("showAdvancedOptions")&&l.advancedOptBtn.onclick(null,true),h<=0?console.info("no differences found."):f.options>0&&console.info("[message] you may recover old configuration of ".concat(f.options," option(s), by open the blob: URL below ON THIS TAB:\n%c").concat(URL.createObjectURL(f.blob)),"color: #15c;"),console.info("import settings: finished."),console.groupEnd(),(P=VApi&&VApi.y().r)&&P.querySelector("#HCls")&&g("force"),VApi&&VApi.h(1,0,t.t("importOK"))}else VApi&&VApi.h(1,0,t.t("cancelImport"))})}function d(n,e,i){var r,l,u,s,c,a=null,d=null,p="";try{(r=m(i?e:e.replace(/\xa0/g," ")))instanceof Error?d=r:r?a=r:p=t.t("notJSON")}catch(n){d=n}return null!=d&&(p=d?(d.message||d)+"":t.t("exc")+(""!==d?d:t.t("unknown")),p=(l=/^(\d+):(\d+)$/.exec(p))?t.t("JSONParseError",[l[1],l[2]]):p),a?(n=+new Date(a.time||("object"==typeof n?+n:n))||0,"Vimium C"!==a.name&&"Vimium++"!==a.name||n<1e4&&n>0?(p=t.t("notVCJSON"),alert(p)):(u=t.r.n.keyMappings.Q?Promise.resolve():o.bn("./options_checker.js"),s=n,c=a,void u.then(function(){setTimeout(f,17,s,c,i)}))):alert(p)}function m(n){function e(){return/a?/.test("")}function o(n){for(var e=n.length;i.length<e;i+=i);return i.slice(0,e)}var t,i,r,l,u,s,c,a=/[^\r\n]+/g;if(!n||!(n=n.trimRight()))return null;i=" ";try{return r=JSON.parse(n.replace(/"(?:\\[^\r\n]|[^"\\\r\n])*"|'(?:\\[^\r\n]|[^'\\\r\n])*'|(?:\/\/|#)[^\r\n]*|\/\*[^]*?\*\//g,function(n){var e=n[0];return"/"===e||"#"===e?n.startsWith("/*")?n.replace(a,o):o(n):n})),e(),r}catch(n){if(t=/\b(?:position (\d+)|line (\d+) column (\d+))/.exec(n+""),e(),!t||!t[0])throw n}return t[2]?(l=+t[2],u=+t[3]):+t[1]>0?(s=n.includes("\r")?n.includes("\r\n")?"\r\n":"\r":"\n",u=(c=n.slice(0,+t[1]).split(s))[(l=c.length)-1].length+1):l=u=1,new SyntaxError(l+":"+u)}var p,g,v,y,b,h,_,w;Object.defineProperty(e,"__esModule",{value:true}),p=["ignoreKeyboardLayout","ignoreCapsLock","mapModifier"],g=function(n){var e,t,i,r,u;if(VApi&&VApi.z){if(t=VApi.y().r,i=false,n&&"force"!==n&&o.Kt(n),t&&(e=t.querySelector("#HCls"))){if("force"!==n&&null!=t.querySelector(".HelpCommandName"))return void o._n(e);i=!!(u=(r=t.querySelector("#HDlg"))&&r.parentElement||r)&&u.remove!==HTMLElement.prototype.remove,u&&(u.remove=HTMLElement.prototype.remove)}VApi.r[0](40,{i:1,q:[{n:24,q:null}]},i||"#commands"===location.hash?function(){var n,e=VApi&&VApi.y(),t=e&&e.r&&e.r.querySelector("#HDlg");t&&((n=t.parentElement||t).remove=function(){HTMLElement.prototype.remove.call(n),location.hash="","none"!=o.$("#optionalPermissionsBox").style.display&&l.wn("#optionalPermissions")})}:function(){})}else o.Sn.then(g.bind(null,n))},o.$("#showCommands").onclick=g,t.s.prototype.Vn=function(n){var e,o,i,r,l,u;if(!n||!this.On){for(l of(o=/^([:^]?[a-z\-?*]+:\/\/)?((?:[^\/]|\/])+)(\/[^\]].*|\/?$)/,e=this.Y()))(r=o.exec(i=l.pattern.replace("(?:[^./]+\\.)*?","*.")))&&r[1]&&r[2]&&(i=r[3]?r[3].replace(/\\\./g,"."):"",(r=r[2].replace(/\\\./g,".").split(".")).reverse(),i=r.join(".")+i),l.kn=i;e.sort(function(n,e){return n.kn<e.kn?-1:n.kn===e.kn?0:1}),this.G(e),this.E(),n&&(u=this,this.On=setTimeout(function(n,e){n.firstChild.data=e,u.On=0},1e3,n,n.firstChild.data),n.firstChild.data=t.t("3_2"))}},o.$("#exclusionSortButton").onclick=function(){t.r.n.exclusionRules.Vn(this)},v="",y=function(n,e){var i,l,u,c,a,f,d,m,g,v,y,h=Object.create(null);for(a of(h.name="Vimium C",e||(h["@time"]=n.toLocaleString(),h.time=n.getTime()),h.environment={extension:r.yn.version,platform:t.u.b},h.environment.chromium=o.Ot,i=t.o(),l=t.u.S,u=Object.keys(i).sort(),b=null,c=function(n){var e=i[n],o=l[n];if(e===o)return"continue";"string"!=typeof o?h[n]=e:e.includes("\n")?(h[n]=e.split("\n").map(function(e){return s(n,e)})).push(""):h[n]=s(n,e)},u))c(a);for(b=null,null!=h.keyLayout&&(9&(f=h.keyLayout)&&(h[p[0]]=8&f?1:2),528&f&&(h[p[1]]=512&f?1:2),192&f&&(h[p[2]]=64&f?1:2)),m=(d=JSON.stringify(h,null,"\t")+"\n").split("\n"),g=0;g<m.length;g++)m[g].replace(/[\u4e00-\u9fff]/g,"  ").length+1>120&&/^\s+"\w+":/.test(m[g])&&(v=m[g].split(":",1)[0]+":",y=(y=m[g].slice(v.length).trimLeft()).replace(/[\u4e00-\u9fff]/g,"  ").length+4>120?y:"\t\t"+y,m[g]=v+"\n"+y);return d=m.join("\n"),"win"===h.environment.platform&&(d=d.replace(/\n/g,"\r\n")),{blob:new Blob([d],{type:"application/json",endings:"native"}),options:u.length}},i.Jt.onclick=function(n){var e,t,i,r,l,s;v&&(URL.revokeObjectURL(v),v=""),e=new Date,i=y(e,t=!!n&&(n.ctrlKey||n.metaKey||n.shiftKey)).blob,r=u(e),l="vimium_c-",l+=t?"settings":r.replace(/[\-:]/g,"").replace(" ","_"),l+=".json",(s=document.createElement("a")).download=l,s.href=URL.createObjectURL(i),o._n(s),v=s.href,console.info("EXPORT settings to %c%s%c at %c%s%c.","color:darkred",l,"color:auto","color:darkblue",r,"color:auto")},b=null,(h=o.$("#settingsFile")).onclick=null,h.onchange=function(){var n,e,o,i=this.files[0];this.value="",i&&(n=t.r.n.vimSync.C?102400:10485760,i.size&&i.size>n?alert(t.t("JSONTooLarge",[i.name,n/1024])):(e=new FileReader,o=i.lastModified||i.lastModifiedDate||0,e.onload=function(){return d(o,this.result,false)},e.readAsText(i)))},(h=o.$("#importOptions")).onclick=null,h.onchange=function(){o.$("#importButton").focus(),"exported"!==this.value?fetch("../settings-template.json").then(function(n){return n.text()}).then(function(n){return d(0,n,true)}):o._n(o.$("#settingsFile"))},h=null,l.delayed_task&&(w=l.delayed_task,l.clear_delayed_task(),(_=o.$(w[0])).onclick&&_.onclick(w[1]))});